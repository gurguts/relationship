-- =====================================================
-- МИГРАЦИЯ: target_user_id -> from_account_id
-- =====================================================
-- Этот скрипт переносит данные из старого поля target_user_id
-- в новое поле from_account_id и удаляет столбец target_user_id
--
-- ВАЖНО: Перед выполнением убедитесь, что:
-- 1. У всех пользователей, имеющих транзакции, есть хотя бы один счет
-- 2. Сделана резервная копия базы данных
-- 3. Проверены транзакции без соответствующих счетов (см. проверки ниже)
-- =====================================================

USE export_data;

-- =====================================================
-- ПРОВЕРКА 1: Транзакции с target_user_id, для которых нет счетов
-- =====================================================
-- Если этот запрос возвращает строки, нужно сначала создать счета для этих пользователей
SELECT 
    t.id AS transaction_id,
    t.target_user_id,
    t.type,
    t.amount,
    t.created_at
FROM transactions t
WHERE t.target_user_id IS NOT NULL
  AND NOT EXISTS (
      SELECT 1
      FROM accounts a
      WHERE a.user_id = t.target_user_id
  );

-- =====================================================
-- ШАГ 1: Обновляем from_account_id на основе target_user_id
-- =====================================================
-- Для каждой транзакции с target_user_id находим первый счет пользователя (MIN(id))
-- Обновляем только те транзакции, у которых from_account_id еще не установлен
UPDATE transactions t
SET from_account_id = (
    SELECT MIN(a.id)
    FROM accounts a
    WHERE a.user_id = t.target_user_id
)
WHERE t.target_user_id IS NOT NULL
  AND t.from_account_id IS NULL
  AND EXISTS (
      SELECT 1
      FROM accounts a
      WHERE a.user_id = t.target_user_id
  );

-- =====================================================
-- ПРОВЕРКА 2: Убеждаемся, что все транзакции обновлены
-- =====================================================
-- Этот запрос должен вернуть 0 строк (или только транзакции, для которых нет счетов)
SELECT 
    COUNT(*) AS transactions_with_target_user_but_no_account
FROM transactions
WHERE target_user_id IS NOT NULL
  AND from_account_id IS NULL;

-- =====================================================
-- ШАГ 2: Удаляем столбец target_user_id
-- =====================================================
-- ВНИМАНИЕ: Это действие необратимо! Убедитесь, что все данные мигрированы.
ALTER TABLE `transactions`
DROP COLUMN `target_user_id`;

-- =====================================================
-- ПРОВЕРКА 3: Убеждаемся, что столбец удален
-- =====================================================
-- Этот запрос должен вернуть ошибку, если столбец успешно удален
-- SELECT target_user_id FROM transactions LIMIT 1;

